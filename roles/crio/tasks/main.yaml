---
- name: Enable kernel modules
  template:
   src: module.conf.j2
   dest: "/etc/modules-load.d/{{ item.name }}.conf"
  with_items:
  - { name: 'br_netfilter', kernel_module: 'br_netfilter' }
  - { name: 'overlay', kernel_module: 'overlay' }
  register: modprobe

- name: modprobe overlay
  community.general.modprobe:
    name: overlay
    state: present
  when: modprobe.changed

- name: modprobe br_netfilter
  community.general.modprobe:
    name: br_netfilter
    state: present
  when: modprobe.changed

- name: pass bridged IPv4 traffic to iptables' chains
  sysctl:
    name: net.bridge.bridge-nf-call-iptables
    value: '1'
    state: present

- name: forward ipv4 packets with iptables
  sysctl:
    name: net.ipv4.ip_forward
    value: '1'
    state: present
